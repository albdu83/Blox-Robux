<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blox R$ - Admin</title>
    <link rel="stylesheet" href="adminpanel.css">
    <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
</head>
<body>
<div id="background">
<div class="container">
  <img src="../img/return.png" alt="retour" id="retour">
  <div id="container">
    <img src="../img/default-avatar.png" alt="avatar" id="roblox">
    <h4 id="pseudoR">...</h4>
    <div id="infos">
  <div class="info-box">
  <span class="label">Robux gagn√©s</span>
  <span class="value" id="robuxGagnes">...</span>
</div>
<div class="info-box">
  <span class="label">Retraits</span>
  <span class="value" id="retraits">...</span>
</div>
<div class="info-box">
  <span class="label">Balance</span>
  <span class="value" id="balance">...</span>
</div>
<div class="info-box">
  <span class="label">Statut</span>
  <span class="value" id="statut">...</span>
</div>
<div class="info-box">
  <span class="label">Nom Roblox</span>
  <span class="value" id="nomRoblox">...</span>
</div>
<div class="info-box">
  <span class="label">Nom d'utilisateur</span>
  <span class="value" id="username">...</span>
</div>
<div class="info-box">
  <span class="label">date de c√©ation</span>
  <span class="value" id="motdepasse">...</span>
</div>
<div class="info-box">
  <span class="label">Nombre de connexions</span>
  <span class="value" id="nbConnexions">...</span>
</div>
  </div>
</div>
  </div>
</div>
    <!-- ===== RIDEAU CHARGEMENT ===== -->
    <div id="transition" class="fade-transition active">
        <img src="../img/Robux.png" id="image" alt="Logo Blox Robux" />
        <div class="text" id="text-chargement">Chargement...</div>
    </div>

    <!-- ===== HEADER ===== -->
    <header>
        <a href="../index.html"><img src="../img/logo.png" alt="Logo De Blox Robux"></a>
        <div class="text">Blox R$</div>
        <img src="../img/Barres.png" alt="Barres" id="barres"> 
    </header>
        <div class="navigation" id="navigation">
  <div class="nav-panel" id="nav-panel">
    <div class="logo2" id="logo2">
        <img src="../img/Back.png" alt="Barres" id="barres2">
    </div>
    <ul class="nave">
        <li>
        <a id="lien-profil" href="#">
          <span>Aucun compte</span>
          <img id="avatar-roblox" src="../img/default-avatar.png">
        </a>
      </li>
      <li><a id="btn-Retour" href="../index.html">Retour</a></li>
    </ul>
  </div>
</div>

    <!-- ===== CONTENU ===== -->
    <main>

        <!-- ===== LISTE UTILISATEURS ===== -->
        <section class="card">
            <h2>Liste des Utilisateurs</h2>

            <div class="search-bar">
                <input type="text" id="search" placeholder="Rechercher un utilisateur...">
                <select id="NBU">
                    <option value="5">Nombre d'utilisateurs :</option>
                    <option value="10">Par 10</option>
                    <option value="30">Par 30</option>
                    <option value="50">Par 50</option>
                    <option value="none">Tous</option>
                </select>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Nom d'utilisateur</th>
                        <th>Solde</th>
                        <th>R√¥le</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="list">
                    <tr>
                        <td colspan="4">Chargement des utilisateurs...</td>
                    </tr>
                </tbody>
            </table>
        </section>
        <!-- ===== PROMOCODES ===== -->
        <section class="card">
            <h2>Promocodes</h2>
            <button class="btn create-promo" id="createPromo">Cr√©er un promocode</button>
            <div class="form-group">
              <input type="text" id="promoName" placeholder="Nom du code (ex: START50)">
              <input type="number" id="promoAmount" placeholder="Montant Robux">
              <input type="number" id="promoUses" placeholder="Nombre d'utilisations">
              <input type="date" id="promoExpiration" placeholder="Date d'expiration">
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Robux</th>
                        <th>Utilisations restantes</th>
                        <th>Expiration</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>START50</td>
                        <td>50</td>
                        <td>12</td>
                        <td>25/02/2025</td>
                        <td><span class="status active">Actif</span></td>
                    </tr>
                    <tr>
                        <td>WIN200</td>
                        <td>200</td>
                        <td>0</td>
                        <td>01/12/2024</td>
                        <td><span class="status inactive">Inactif</span></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- ===== MULTIPLICATEUR ===== -->
        <section class="card">
            <h2>Multiplicateur des Gains</h2>
            <div class="multiplier-box">
                <p>Multiplication actuelle : <span class="current-multiplier">x1.20</span></p>
                <input type="number" placeholder="Nouveau pourcentage (ex: 50 pour x1.50)">
                <button class="btn apply">Appliquer</button>
            </div>
        </section>

        <!-- ===== PLUIE ===== -->
        <section class="card">
            <h2>Cr√©er une Pluie de Robux</h2>
            <div class="rain-form">
                <input type="number" placeholder="Montant total de Robux">
                <input type="number" placeholder="Dur√©e en secondes">
                <button class="btn create-rain">Lancer la pluie</button>
            </div>
        </section>

    </main>

    <!-- ===== FIREBASE ===== -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDwZ7eVgxjrkh6U1kycVyPdjNKJ6b-_xZc",
  authDomain: "bloxrobux-e9244.firebaseapp.com",
  databaseURL: "https://bloxrobux-e9244-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bloxrobux-e9244",
  storageBucket: "bloxrobux-e9244.firebasestorage.app",
  messagingSenderId: "178163807426",
  appId: "1:178163807426:web:649b90d1867023d190b75b",
  measurementId: "G-YWK7EDQ55E"
};
const imgage = document.getElementById("roblox");
// Initialisation Firebase
firebase.initializeApp(firebaseConfig);

async function setRobloxAvatar(robloxName) {
  try {
    const res = await fetch(`https://blox-robux.onrender.com/api/avatar/${robloxName}`);
    const data = await res.json();
    if (!imgage) return;

    imgage.src = data.avatarUrl || "img/default-avatar.png";
    imgage.style.display = "inline-block";

  } catch (err) {
    console.error("Erreur avatar :", err);
  }
}
async function updateProfileInfo(uid) {
  try {
    const snapshot = await db.ref(`users/${uid}`).get();
    if (!snapshot.exists()) return;

    const data = snapshot.val();

    document.getElementById("robuxGagnes").textContent = data.robuxGagnes ?? "0";
    document.getElementById("retraits").textContent = Object.keys(data.transactions || {}).length;
    document.getElementById("balance").textContent = data.balance ?? "0";
    document.getElementById("statut").textContent = data.role ?? "Utilisateur";
    document.getElementById("nomRoblox").textContent = data.RobloxName ?? "‚Äî";
    document.getElementById("username").textContent = data.username ?? "‚Äî";
    const date = data.createdAt ? new Date(data.createdAt).toLocaleDateString() : "‚Äî";
    document.getElementById("motdepasse").textContent = date;
    document.getElementById("nbConnexions").textContent = data.nbConnexions ?? "0";

  } catch (err) {
    console.error("Erreur mise √† jour profil :", err);
  }
}

const auth = firebase.auth();
const db = firebase.database();
let connectedUser = null;
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    alert("Vous devez √™tre connect√© pour acc√©der √† cette page !");
    window.location.href = "../Page de profil/Profil.html";
    return;
  }

  connectedUser = user.uid;

  try {
    const snapshot = await db.ref("users/" + connectedUser).get();
    if (!snapshot.exists()) {
      alert("Utilisateur introuvable !");
      await auth.signOut();
      window.location.href = "../Page de profil/Profil.html";
      return;
    }

    const data = snapshot.val();

    if (data.role !== "admin") {
      alert("Acc√®s refus√© : r√¥le admin requis !");
      await auth.signOut();
      window.location.href = "../Page de profil/Profil.html";
      return;
    }

    // L'utilisateur est admin ‚úÖ, on peut charger la liste des utilisateurs
    loadUsers();

  } catch (err) {
    console.error("Erreur r√©cup√©ration utilisateur :", err);
    alert("Erreur lors du chargement de votre compte");
  }
});

// ------------------------
// CHARGER LES UTILISATEURS
// ------------------------
const list = document.getElementById("list");
const searchInput = document.getElementById("search");
const nbuInput = document.getElementById("NBU");
const background = document.getElementById("background");
const pseudoR = document.getElementById("pseudoR");
const retour = document.getElementById("retour")
let allUsers = [];

retour.addEventListener("click", () => {
  background.classList.remove("active")
  background.addEventListener("transitionend", () => {
    background.style.display = "none";
    pseudoR.innerHTML = "...";
    imgage.src = "../img/default-avatar.png";
    document.getElementById("robuxGagnes").textContent = "...";
    document.getElementById("retraits").textContent = "...";
    document.getElementById("balance").textContent = "...";
    document.getElementById("statut").textContent = "...";
    document.getElementById("nomRoblox").textContent = "...";
    document.getElementById("username").textContent = "...";
    document.getElementById("motdepasse").textContent = "...";
    document.getElementById("nbConnexions").textContent = "...";
  }, { once: true })
});

list.addEventListener("click", async (e) => {
  const btn = e.target;
  const tr = btn.closest("tr");
  if (!tr) return;

  const uid = tr.dataset.uid;
  if (!uid) return;

  // PROFIL
  if (btn.classList.contains("profil")) {
    background.style.display = "flex"
    setTimeout(() => {
      background.classList.toggle("active")
    }, 0);
    const snap = await db.ref(`users/${uid}/RobloxName`).get()
    const robloxName = snap.val()
    if (!robloxName) return alert("alertee");
    pseudoR.innerHTML = `@${robloxName}`;
    setRobloxAvatar(robloxName);
    updateProfileInfo(uid);
  }

  // CR√âDITER
  if (btn.classList.contains("credit")) {
    const amount = prompt("Montant √† cr√©diter :");
    if (!amount || isNaN(amount)) return;

    await db.ref(`users/${uid}/balance`)
      .transaction(b => (b || 0) + Number(amount));

    alert("‚úÖ Cr√©dit ajout√©");
    loadUsers();
  }

  // BANNIR
if (btn.classList.contains("ban")) {
  const isBanned = tr.dataset.banned === "true"; // r√©cup√®re l'√©tat actuel

  const confirmMsg = isBanned 
    ? "Voulez-vous d√©bannir cet utilisateur ?" 
    : "Confirmer le bannissement ?";

  if (!confirm(confirmMsg)) return;

  // Mettre √† jour la base de donn√©es
  await db.ref(`users/${uid}/banned`).set(!isBanned);

  alert(
    !isBanned 
      ? "üö´ Utilisateur banni" 
      : "‚úÖ Utilisateur d√©banni"
  );

  loadUsers(); // Recharge la liste pour mettre √† jour le bouton et le dataset
}

  // PROMOUVOIR
if (btn.classList.contains("promote")) {
  if (uid === connectedUser) {
    return alert("‚ùå Vous ne pouvez pas modifier votre propre r√¥le.");
  }

  const currentRole = tr.dataset.role;
  const newRole = currentRole === "admin" ? "Utilisateur" : "admin";

  const confirmMsg =
    newRole === "admin"
      ? "Promouvoir cet utilisateur en admin ?"
      : "Retirer le r√¥le admin √† cet utilisateur ?";

  if (!confirm(confirmMsg)) return;

  await db.ref(`users/${uid}/role`).set(newRole);

  alert(
    newRole === "admin"
      ? "‚≠ê Utilisateur promu admin"
      : "‚¨áÔ∏è R√¥le admin retir√©"
  );

  loadUsers();
}
});

async function loadUsers() {
  try {
    const snapshot = await db.ref("users").get();
    if (!snapshot.exists()) {
      list.innerHTML = "<tr><td colspan='4'>Aucun utilisateur trouv√©.</td></tr>";
      return;
    }

    const users = snapshot.val();
    allUsers = Object.keys(users).map(uid => ({
      uid: uid,
      username: users[uid].username ,
      balance: users[uid].balance || 0,
      role: (users[uid].role || "Utilisateur").toLowerCase(),
      banned: users[uid].banned || false
    }));

    renderUsers();

    // √âv√©nements recherche et limite
    if (searchInput) searchInput.addEventListener("input", renderUsers);
    if (nbuInput) nbuInput.addEventListener("input", renderUsers);

  } catch (err) {
    console.error("Erreur chargement utilisateurs :", err);
    list.innerHTML = "<tr><td colspan='4'>Erreur lors du chargement des utilisateurs.</td></tr>";
  }
}

// ------------------------
// AFFICHER LES UTILISATEURS
// ------------------------
function renderUsers() {
  const search = searchInput?.value.toLowerCase() || "";
  const limit = nbuInput?.value === "none" ? allUsers.length : Number(nbuInput?.value) || allUsers.length;

  list.innerHTML = "";
  let count = 0;

  for (const user of allUsers) {
    if (
        !user.username ||
        !user.username.toLowerCase().includes(search)
    ) continue;
    if (count >= limit) break;
    count++;

    const tr = document.createElement("tr");
    tr.dataset.role = user.role;
    tr.dataset.uid = user.uid;
    tr.dataset.banned = user.banned || false;
    const isAdmin = user.role === "admin";
    tr.innerHTML = `
      <td>${user.username ?? "‚Äî"}</td>
      <td>${user.balance} R$</td>
      <td>${user.role}</td>
      <td class="actions">
        <button class="btn profil">Profil</button>
        <button class="btn credit">Cr√©diter</button>
        <button class="btn ban">${user.banned ? "D√©bannir" : "Bannir"}</button>
        <button class="btn promote">
          ${isAdmin ? "R√©trograder" : "Promouvoir"}
        </button>
      </td>
    `;
    list.appendChild(tr);
  }

  if (count === 0) {
    list.innerHTML = "<tr><td colspan='4'>Aucun utilisateur trouv√©.</td></tr>";
  }
}

// ------------------------
// CODES PROMOS CREATIONS
// ------------------------

document.getElementById("createPromo").addEventListener("click", async () => {
    const name = document.getElementById("promoName").value.trim().toUpperCase();
    const amount = parseInt(document.getElementById("promoAmount").value);
    const uses = parseInt(document.getElementById("promoUses").value);
    const expiration = document.getElementById("promoExpiration").value; // yyyy-mm-dd

    if (!name || !amount || isNaN(uses) || !expiration) return alert("Remplissez tous les champs");

    try {
        await db.ref(`promocodes/${name}`).set({
            amount: amount,
            usesLeft: uses,
            expiration: new Date(expiration).toISOString(),
            usedBy: {}
        });
        alert("‚úîÔ∏è Code promo cr√©√© !");
    } catch (err) {
        console.error(err);
        alert("‚ùå Erreur lors de la cr√©ation du code");
    }
});
const promoTableBody = document.querySelector("section.card:nth-of-type(2) tbody"); // tbody de la section Promocodes

async function loadPromocodes() {
    try {
        const snapshot = await db.ref("promocodes").get();
        promoTableBody.innerHTML = ""; // vider le tableau

        if (!snapshot.exists()) {
            promoTableBody.innerHTML = "<tr><td colspan='5'>Aucun code promo trouv√©.</td></tr>";
            return;
        }

        const promos = snapshot.val();
        const now = new Date();

        Object.keys(promos).forEach(code => {
            const promo = promos[code];
            const expirationDate = promo.expiration ? new Date(promo.expiration) : null;
            const usesLeft = promo.usesLeft !== undefined ? promo.usesLeft : "‚àû";

            // Statut
            let status = "Actif";
            if ((expirationDate && expirationDate < now) || (promo.usesLeft !== undefined && promo.usesLeft <= 0)) {
                status = "Inactif";
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${code}</td>
                <td>${promo.amount}</td>
                <td>${usesLeft}</td>
                <td>${expirationDate ? expirationDate.toLocaleDateString() : "‚àû"}</td>
                <td><span class="status ${status.toLowerCase()}">${status}</span></td>
            `;
            promoTableBody.appendChild(tr);
        });

    } catch (err) {
        console.error("Erreur chargement promos :", err);
        promoTableBody.innerHTML = "<tr><td colspan='5'>Erreur lors du chargement des codes promo.</td></tr>";
    }
}

// Charger les codes au d√©marrage
loadPromocodes();
</script>
<script src="../Server.js" defer></script>
<script src="../Animation.js" defer></script>
</body>
</html>
