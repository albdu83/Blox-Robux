<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blox R$ - Admin</title>
    <link rel="stylesheet" href="adminpanel.css">
    <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
</head>
<body>

    <!-- ===== RIDEAU CHARGEMENT ===== -->
    <div id="transition" class="fade-transition active">
        <img src="../img/Robux.png" id="image" alt="Logo Blox Robux" />
        <div class="text" id="text-chargement">Chargement...</div>
    </div>

    <!-- ===== HEADER ===== -->
    <header>
        <a href="../index.html"><img src="../img/logo.png" alt="Logo De Blox Robux"></a>
        <div class="text">Blox R$</div>
        <ul>
            <li><a id="btn-connexion" href="../Page de profil/Profil.html">Retour</a></li>
            <li>
                <a id="lien-profil" href="../Page de profil/Profil.html" style="display:flex; align-items:center; gap:10px;">
                    <span>Aucun compte</span>
                    <img id="avatar-roblox" src="../img/default-avatar.png" style="width:40px; height:40px; border-radius:50%;">
                </a>
            </li>
        </ul>
    </header>

    <!-- ===== CONTENU ===== -->
    <main>

        <!-- ===== LISTE UTILISATEURS ===== -->
        <section class="card">
            <h2>Liste des Utilisateurs</h2>

            <div class="search-bar">
                <input type="text" id="search" placeholder="Rechercher un utilisateur...">
                <select id="NBU">
                    <option value="5">Nombre d'utilisateurs :</option>
                    <option value="10">Par 10</option>
                    <option value="30">Par 30</option>
                    <option value="50">Par 50</option>
                    <option value="none">Tous</option>
                </select>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Nom d'utilisateur</th>
                        <th>Solde</th>
                        <th>R√¥le</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="list">
                    <tr>
                        <td colspan="4">Chargement des utilisateurs...</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- ===== PROMOCODES ===== -->
        <section class="card">
            <h2>Promocodes</h2>
            <button class="btn create-promo" id="createPromo">Cr√©er un promocode</button>
            <div class="form-group">
              <input type="text" id="promoName" placeholder="Nom du code (ex: START50)">
              <input type="number" id="promoAmount" placeholder="Montant Robux">
              <input type="number" id="promoUses" placeholder="Nombre d'utilisations">
              <input type="date" id="promoExpiration" placeholder="Date d'expiration">
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Robux</th>
                        <th>Utilisations restantes</th>
                        <th>Expiration</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>START50</td>
                        <td>50</td>
                        <td>12</td>
                        <td>25/02/2025</td>
                        <td><span class="status active">Actif</span></td>
                    </tr>
                    <tr>
                        <td>WIN200</td>
                        <td>200</td>
                        <td>0</td>
                        <td>01/12/2024</td>
                        <td><span class="status inactive">Inactif</span></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- ===== MULTIPLICATEUR ===== -->
        <section class="card">
            <h2>Multiplicateur des Gains</h2>
            <div class="multiplier-box">
                <p>Multiplication actuelle : <span class="current-multiplier">x1.20</span></p>
                <input type="number" placeholder="Nouveau pourcentage (ex: 50 pour x1.50)">
                <button class="btn apply">Appliquer</button>
            </div>
        </section>

        <!-- ===== PLUIE ===== -->
        <section class="card">
            <h2>Cr√©er une Pluie de Robux</h2>
            <div class="rain-form">
                <input type="number" placeholder="Montant total de Robux">
                <input type="number" placeholder="Dur√©e en secondes">
                <button class="btn create-rain">Lancer la pluie</button>
            </div>
        </section>

    </main>

    <!-- ===== FIREBASE ===== -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDwZ7eVgxjrkh6U1kycVyPdjNKJ6b-_xZc",
  authDomain: "bloxrobux-e9244.firebaseapp.com",
  databaseURL: "https://bloxrobux-e9244-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bloxrobux-e9244",
  storageBucket: "bloxrobux-e9244.firebasestorage.app",
  messagingSenderId: "178163807426",
  appId: "1:178163807426:web:649b90d1867023d190b75b",
  measurementId: "G-YWK7EDQ55E"
};

// Initialisation Firebase
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
let connectedUser = null;
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    alert("Vous devez √™tre connect√© pour acc√©der √† cette page !");
    window.location.href = "../Page de profil/Profil.html";
    return;
  }

  connectedUser = user.uid;

  try {
    const snapshot = await db.ref("users/" + connectedUser).get();
    if (!snapshot.exists()) {
      alert("Utilisateur introuvable !");
      await auth.signOut();
      window.location.href = "../Page de profil/Profil.html";
      return;
    }

    const data = snapshot.val();

    if (data.role !== "admin") {
      alert("Acc√®s refus√© : r√¥le admin requis !");
      await auth.signOut();
      window.location.href = "../Page de profil/Profil.html";
      return;
    }

    // L'utilisateur est admin ‚úÖ, on peut charger la liste des utilisateurs
    loadUsers();

  } catch (err) {
    console.error("Erreur r√©cup√©ration utilisateur :", err);
    alert("Erreur lors du chargement de votre compte");
  }
});

// ------------------------
// CHARGER LES UTILISATEURS
// ------------------------
const list = document.getElementById("list");
const searchInput = document.getElementById("search");
const nbuInput = document.getElementById("NBU");
let allUsers = [];

list.addEventListener("click", async (e) => {
  const btn = e.target;
  const tr = btn.closest("tr");
  if (!tr) return;

  const uid = tr.dataset.uid;
  if (!uid) return;

  // PROFIL
  if (btn.classList.contains("profil")) {
    window.location.href = `../Page de profil/Profil.html?uid=${uid}`;
  }

  // CR√âDITER
  if (btn.classList.contains("credit")) {
    const amount = prompt("Montant √† cr√©diter :");
    if (!amount || isNaN(amount)) return;

    await db.ref(`users/${uid}/balance`)
      .transaction(b => (b || 0) + Number(amount));

    alert("‚úÖ Cr√©dit ajout√©");
    loadUsers();
  }

  // BANNIR
if (btn.classList.contains("ban")) {
  const isBanned = tr.dataset.banned === "true"; // r√©cup√®re l'√©tat actuel

  const confirmMsg = isBanned 
    ? "Voulez-vous d√©bannir cet utilisateur ?" 
    : "Confirmer le bannissement ?";

  if (!confirm(confirmMsg)) return;

  // Mettre √† jour la base de donn√©es
  await db.ref(`users/${uid}/banned`).set(!isBanned);

  alert(
    !isBanned 
      ? "üö´ Utilisateur banni" 
      : "‚úÖ Utilisateur d√©banni"
  );

  loadUsers(); // Recharge la liste pour mettre √† jour le bouton et le dataset
}

  // PROMOUVOIR
if (btn.classList.contains("promote")) {
  if (uid === connectedUser) {
    return alert("‚ùå Vous ne pouvez pas modifier votre propre r√¥le.");
  }

  const currentRole = tr.dataset.role;
  const newRole = currentRole === "admin" ? "Utilisateur" : "admin";

  const confirmMsg =
    newRole === "admin"
      ? "Promouvoir cet utilisateur en admin ?"
      : "Retirer le r√¥le admin √† cet utilisateur ?";

  if (!confirm(confirmMsg)) return;

  await db.ref(`users/${uid}/role`).set(newRole);

  alert(
    newRole === "admin"
      ? "‚≠ê Utilisateur promu admin"
      : "‚¨áÔ∏è R√¥le admin retir√©"
  );

  loadUsers();
}
});

async function loadUsers() {
  try {
    const snapshot = await db.ref("users").get();
    if (!snapshot.exists()) {
      list.innerHTML = "<tr><td colspan='4'>Aucun utilisateur trouv√©.</td></tr>";
      return;
    }

    const users = snapshot.val();
    allUsers = Object.keys(users).map(uid => ({
      uid: uid,
      username: users[uid].username ,
      balance: users[uid].balance || 0,
      role: (users[uid].role || "Utilisateur").toLowerCase(),
      banned: users[uid].banned || false
    }));

    renderUsers();

    // √âv√©nements recherche et limite
    if (searchInput) searchInput.addEventListener("input", renderUsers);
    if (nbuInput) nbuInput.addEventListener("input", renderUsers);

  } catch (err) {
    console.error("Erreur chargement utilisateurs :", err);
    list.innerHTML = "<tr><td colspan='4'>Erreur lors du chargement des utilisateurs.</td></tr>";
  }
}

// ------------------------
// AFFICHER LES UTILISATEURS
// ------------------------
function renderUsers() {
  const search = searchInput?.value.toLowerCase() || "";
  const limit = nbuInput?.value === "none" ? allUsers.length : Number(nbuInput?.value) || allUsers.length;

  list.innerHTML = "";
  let count = 0;

  for (const user of allUsers) {
    if (
        !user.username ||
        !user.username.toLowerCase().includes(search)
    ) continue;
    if (count >= limit) break;
    count++;

    const tr = document.createElement("tr");
    tr.dataset.role = user.role;
    tr.dataset.uid = user.uid;
    tr.dataset.banned = user.banned || false;
    const isAdmin = user.role === "admin";
    tr.innerHTML = `
      <td>${user.username ?? "‚Äî"}</td>
      <td>${user.balance} R$</td>
      <td>${user.role}</td>
      <td class="actions">
        <button class="btn profil">Profil</button>
        <button class="btn credit">Cr√©diter</button>
        <button class="btn ban">${user.banned ? "D√©bannir" : "Bannir"}</button>
        <button class="btn promote">
          ${isAdmin ? "R√©trograder" : "Promouvoir"}
        </button>
      </td>
    `;
    list.appendChild(tr);
  }

  if (count === 0) {
    list.innerHTML = "<tr><td colspan='4'>Aucun utilisateur trouv√©.</td></tr>";
  }
}

// ------------------------
// CODES PROMOS CREATIONS
// ------------------------

document.getElementById("createPromo").addEventListener("click", async () => {
    const name = document.getElementById("promoName").value.trim().toUpperCase();
    const amount = parseInt(document.getElementById("promoAmount").value);
    const uses = parseInt(document.getElementById("promoUses").value);
    const expiration = document.getElementById("promoExpiration").value; // yyyy-mm-dd

    if (!name || !amount || isNaN(uses) || !expiration) return alert("Remplissez tous les champs");

    try {
        await db.ref(`promocodes/${name}`).set({
            amount: amount,
            usesLeft: uses,
            expiration: new Date(expiration).toISOString(),
            usedBy: {}
        });
        alert("‚úîÔ∏è Code promo cr√©√© !");
    } catch (err) {
        console.error(err);
        alert("‚ùå Erreur lors de la cr√©ation du code");
    }
});
const promoTableBody = document.querySelector("section.card:nth-of-type(2) tbody"); // tbody de la section Promocodes

async function loadPromocodes() {
    try {
        const snapshot = await db.ref("promocodes").get();
        promoTableBody.innerHTML = ""; // vider le tableau

        if (!snapshot.exists()) {
            promoTableBody.innerHTML = "<tr><td colspan='5'>Aucun code promo trouv√©.</td></tr>";
            return;
        }

        const promos = snapshot.val();
        const now = new Date();

        Object.keys(promos).forEach(code => {
            const promo = promos[code];
            const expirationDate = promo.expiration ? new Date(promo.expiration) : null;
            const usesLeft = promo.usesLeft !== undefined ? promo.usesLeft : "‚àû";

            // Statut
            let status = "Actif";
            if ((expirationDate && expirationDate < now) || (promo.usesLeft !== undefined && promo.usesLeft <= 0)) {
                status = "Inactif";
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${code}</td>
                <td>${promo.amount}</td>
                <td>${usesLeft}</td>
                <td>${expirationDate ? expirationDate.toLocaleDateString() : "‚àû"}</td>
                <td><span class="status ${status.toLowerCase()}">${status}</span></td>
            `;
            promoTableBody.appendChild(tr);
        });

    } catch (err) {
        console.error("Erreur chargement promos :", err);
        promoTableBody.innerHTML = "<tr><td colspan='5'>Erreur lors du chargement des codes promo.</td></tr>";
    }
}

// Charger les codes au d√©marrage
loadPromocodes();
</script>
<script src="../Server.js" defer></script>
<script src="../Animation.js" defer></script>
</body>
</html>
