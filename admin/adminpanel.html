<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blox R$ - Admin</title>
    <link rel="stylesheet" href="adminpanel.css">
    <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
</head>
<body>

    <!-- ===== RIDEAU CHARGEMENT ===== -->
    <div id="transition" class="fade-transition active">
        <img src="../img/Robux.png" id="image" alt="Logo Blox Robux" />
        <div class="text" id="text-chargement">Chargement...</div>
    </div>

    <!-- ===== HEADER ===== -->
    <header>
        <a href="../index.html"><img src="../img/logo.png" alt="Logo De Blox Robux"></a>
        <div class="text">Blox R$</div>
        <ul>
            <li><a id="btn-connexion" href="../Page de profil/Profil.html">Retour</a></li>
            <li>
                <a id="lien-profil" href="../Page de profil/Profil.html" style="display:flex; align-items:center; gap:10px;">
                    <span>Aucun compte</span>
                    <img id="avatar-roblox" src="../img/default-avatar.png" style="width:40px; height:40px; border-radius:50%;">
                </a>
            </li>
        </ul>
    </header>

    <!-- ===== CONTENU ===== -->
    <main>

        <!-- ===== LISTE UTILISATEURS ===== -->
        <section class="card">
            <h2>Liste des Utilisateurs</h2>

            <div class="search-bar">
                <input type="text" id="search" placeholder="Rechercher un utilisateur...">
                <select id="NBU">
                    <option value="5">Nombre d'utilisateurs :</option>
                    <option value="10">Par 10</option>
                    <option value="30">Par 30</option>
                    <option value="50">Par 50</option>
                    <option value="none">Tous</option>
                </select>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Nom d'utilisateur</th>
                        <th>Solde</th>
                        <th>Rôle</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="list">
                    <tr>
                        <td colspan="4">Chargement des utilisateurs...</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- ===== PROMOCODES ===== -->
        <section class="card">
            <h2>Promocodes</h2>
            <button class="btn create-promo" id="createPromo">Créer un promocode</button>
            <div class="form-group">
              <input type="text" id="promoName" placeholder="Nom du code (ex: START50)">
              <input type="number" id="promoAmount" placeholder="Montant Robux">
              <input type="number" id="promoUses" placeholder="Nombre d'utilisations">
              <input type="date" id="promoExpiration" placeholder="Date d'expiration">
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Robux</th>
                        <th>Utilisations restantes</th>
                        <th>Expiration</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>START50</td>
                        <td>50</td>
                        <td>12</td>
                        <td>25/02/2025</td>
                        <td><span class="status active">Actif</span></td>
                    </tr>
                    <tr>
                        <td>WIN200</td>
                        <td>200</td>
                        <td>0</td>
                        <td>01/12/2024</td>
                        <td><span class="status inactive">Inactif</span></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- ===== MULTIPLICATEUR ===== -->
        <section class="card">
            <h2>Multiplicateur des Gains</h2>
            <div class="multiplier-box">
                <p>Multiplication actuelle : <span class="current-multiplier">x1.20</span></p>
                <input type="number" placeholder="Nouveau pourcentage (ex: 50 pour x1.50)">
                <button class="btn apply">Appliquer</button>
            </div>
        </section>

        <!-- ===== PLUIE ===== -->
        <section class="card">
            <h2>Créer une Pluie de Robux</h2>
            <div class="rain-form">
                <input type="number" placeholder="Montant total de Robux">
                <input type="number" placeholder="Durée en secondes">
                <button class="btn create-rain">Lancer la pluie</button>
            </div>
        </section>

    </main>

    <!-- ===== FIREBASE ===== -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDwZ7eVgxjrkh6U1kycVyPdjNKJ6b-_xZc",
  authDomain: "bloxrobux-e9244.firebaseapp.com",
  databaseURL: "https://bloxrobux-e9244-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bloxrobux-e9244",
  storageBucket: "bloxrobux-e9244.firebasestorage.app",
  messagingSenderId: "178163807426",
  appId: "1:178163807426:web:649b90d1867023d190b75b",
  measurementId: "G-YWK7EDQ55E"
};

// Initialisation Firebase
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
let connectedUser = null;
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    alert("Vous devez être connecté pour accéder à cette page !");
    window.location.href = "../Page de profil/Profil.html";
    return;
  }

  connectedUser = user.uid;

  try {
    const snapshot = await db.ref("users/" + connectedUser).get();
    if (!snapshot.exists()) {
      alert("Utilisateur introuvable !");
      await auth.signOut();
      window.location.href = "../Page de profil/Profil.html";
      return;
    }

    const data = snapshot.val();

    if (data.role !== "admin") {
      alert("Accès refusé : rôle admin requis !");
      await auth.signOut();
      window.location.href = "../Page de profil/Profil.html";
      return;
    }

    // L'utilisateur est admin ✅, on peut charger la liste des utilisateurs
    loadUsers();

  } catch (err) {
    console.error("Erreur récupération utilisateur :", err);
    alert("Erreur lors du chargement de votre compte");
  }
});

// ------------------------
// CHARGER LES UTILISATEURS
// ------------------------
const list = document.getElementById("list");
const searchInput = document.getElementById("search");
const nbuInput = document.getElementById("NBU");
let allUsers = [];

async function loadUsers() {
  try {
    const snapshot = await db.ref("users").get();
    if (!snapshot.exists()) {
      list.innerHTML = "<tr><td colspan='4'>Aucun utilisateur trouvé.</td></tr>";
      return;
    }

    const users = snapshot.val();
    allUsers = Object.keys(users).map(uid => ({
      username: users[uid].username || uid,
      balance: users[uid].balance || 0,
      role: users[uid].role || "Utilisateur"
    }));

    renderUsers();

    // Événements recherche et limite
    if (searchInput) searchInput.addEventListener("input", renderUsers);
    if (nbuInput) nbuInput.addEventListener("input", renderUsers);

  } catch (err) {
    console.error("Erreur chargement utilisateurs :", err);
    list.innerHTML = "<tr><td colspan='4'>Erreur lors du chargement des utilisateurs.</td></tr>";
  }
}

// ------------------------
// AFFICHER LES UTILISATEURS
// ------------------------
function renderUsers() {
  const search = searchInput?.value.toLowerCase() || "";
  const limit = nbuInput?.value === "none" ? allUsers.length : Number(nbuInput?.value) || allUsers.length;

  list.innerHTML = "";
  let count = 0;

  for (const user of allUsers) {
    if (!user.username.toLowerCase().includes(search)) continue;
    if (count >= limit) break;
    count++;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${user.username}</td>
      <td>${user.balance} R$</td>
      <td>${user.role}</td>
      <td class="actions">
        <button class="btn profil">Profil</button>
        <button class="btn credit">Créditer</button>
        <button class="btn ban">Bannir</button>
        <button class="btn promote">Promouvoir</button>
      </td>
    `;
    list.appendChild(tr);
  }

  if (count === 0) {
    list.innerHTML = "<tr><td colspan='4'>Aucun utilisateur trouvé.</td></tr>";
  }
}

// ------------------------
// CODES PROMOS CREATIONS
// ------------------------

document.getElementById("createPromo").addEventListener("click", async () => {
    const name = document.getElementById("promoName").value.trim().toUpperCase();
    const amount = parseInt(document.getElementById("promoAmount").value);
    const uses = parseInt(document.getElementById("promoUses").value);
    const expiration = document.getElementById("promoExpiration").value; // yyyy-mm-dd

    if (!name || !amount || isNaN(uses) || !expiration) return alert("Remplissez tous les champs");

    try {
        await db.ref(`promocodes/${name}`).set({
            amount: amount,
            usesLeft: uses,
            expiration: new Date(expiration).toISOString(),
            usedBy: {}
        });
        alert("✔️ Code promo créé !");
    } catch (err) {
        console.error(err);
        alert("❌ Erreur lors de la création du code");
    }
});
const promoTableBody = document.querySelector("section.card:nth-of-type(2) tbody"); // tbody de la section Promocodes

async function loadPromocodes() {
    try {
        const snapshot = await db.ref("promocodes").get();
        promoTableBody.innerHTML = ""; // vider le tableau

        if (!snapshot.exists()) {
            promoTableBody.innerHTML = "<tr><td colspan='5'>Aucun code promo trouvé.</td></tr>";
            return;
        }

        const promos = snapshot.val();
        const now = new Date();

        Object.keys(promos).forEach(code => {
            const promo = promos[code];
            const expirationDate = promo.expiration ? new Date(promo.expiration) : null;
            const usesLeft = promo.usesLeft !== undefined ? promo.usesLeft : "∞";

            // Statut
            let status = "Actif";
            if ((expirationDate && expirationDate < now) || (promo.usesLeft !== undefined && promo.usesLeft <= 0)) {
                status = "Inactif";
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${code}</td>
                <td>${promo.amount}</td>
                <td>${usesLeft}</td>
                <td>${expirationDate ? expirationDate.toLocaleDateString() : "∞"}</td>
                <td><span class="status ${status.toLowerCase()}">${status}</span></td>
            `;
            promoTableBody.appendChild(tr);
        });

    } catch (err) {
        console.error("Erreur chargement promos :", err);
        promoTableBody.innerHTML = "<tr><td colspan='5'>Erreur lors du chargement des codes promo.</td></tr>";
    }
}

// Charger les codes au démarrage
loadPromocodes();
</script>
<script src="../Server.js" defer></script>
<script src="../Animation.js" defer></script>
</body>
</html>
