<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blox Robux - Gagner</title>
  <link rel="stylesheet" href="stylegagner.css">
  <link rel="icon" href="../img/imagePrinc.webp" type="image/x-icon">
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="header-left">
      <a href="../index.html">
        <img src="../img/logo.png" alt="Logo Blox Robux" />
      </a>
      <div class="solde-box">
        <span>ðŸ’° Solde :</span>
        <span id="balance">0,00 R$</span>
      </div>
      <div class="text">BloxRobux</div>
    </div>
    <ul>
      <li><a href="../index.html">Accueil</a></li>
      <li><a href="gagner.html">Gagner des Robux</a></li>
      <li><a href="../Page de retraits/retirer.html">Retirer</a></li>
    </ul>
  </header>
  <!-- INFORMATIONS -->
  <div class="informations" id="info">
    <p>ðŸ’³ ComplÃ©tez des offres sur nos <strong>sites partenaires</strong> pour Ãªtre rÃ©compensÃ©s ! Obtenez de l'aide sur <a href="https://discord.gg/QQMRtfBXpq">notre serveur Discord</a>.</p>
  </div>

  <!-- BITLABS -->
  <ul id="pk">
    <li><img src="../img/Bitlabs Logo.jfif" id="reload-bitlabs" alt="Reload Bitlabs"></li>
    <li><img src="../img/Timewall.png" id="btnGagner" alt="Gagner des Robux"></li>
  </ul>

  <div class="informations" id="info">
    <div class="bitLabs" id="bitlabs">
      <iframe src="https://web.bitlabs.ai/?uid=12345&token=5fe6d711-ec6d-4a09-b6a6-343b8f0d3c9b" id="offerwall1"></iframe>
    </div>
  </div>

  <div class="TimeWall" id="TimeWall">
    <div id="timewall-container"></div>
  </div>

  <!-- TRANSITION -->
  <div id="transition" class="fade-transition active">
    <img src="../img/Robux.png" id="image" alt="Logo Blox Robux" />
    <div class="text" id="text-chargement">Chargement...</div>
  </div>

  <!-- SCRIPT TIMEWALL ET FIREBASE -->
  <script src="https://www.timewall.com/widget.js?site_id=2578908b35321055" defer></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Scripts dÃ©fÃ©rÃ©s -->
  <script src="../Data.js" defer></script>
  <script src="../Server.js" defer></script>
  <script src="../Animation.js" defer></script>
  <script src="../Amount.js" defer></script>

  <!-- SCRIPT PRINCIPAL -->
<script defer>
document.addEventListener("DOMContentLoaded", () => {
    const db = window.db;
    if (!db) return console.error("Firebase Database non initialisÃ©e !");

    const balanceEl = document.getElementById("balance");
    const btnGagner = document.getElementById("btnGagner");
    const reloadBtn = document.getElementById("reload-bitlabs");

    const API_BASE = "https://blox-robux.onrender.com";

    // --- RÃ©cupÃ©ration ou crÃ©ation ID utilisateur ---
    function getUserID() {
        let userID = localStorage.getItem("userID");
        if (!userID) {
            userID = "user_" + Math.random().toString(36).substr(2, 9);
            localStorage.setItem("userID", userID);
            db.ref("users/" + userID).set({ createdAt: Date.now(), balance: 0 })
              .catch(err => console.error("Erreur crÃ©ation utilisateur :", err));
        }
        return userID;
    }
    const userID = getUserID();

    // --- Mise Ã  jour du solde ---
    function updateBalance(amount) {
        const current = parseFloat(balanceEl.innerText.replace(" R$", "").replace(",", ".")) || 0;
        const newBalance = current + amount;
        balanceEl.textContent = newBalance.toFixed(2) + " R$";
        db.ref("users/" + userID + "/balance").set(newBalance).catch(err => console.error(err));
    }

    if (btnGagner) {
        btnGagner.addEventListener("click", () => {
          const iframe = document.getElementById("timewall-container");
            if (iframe) iframe.src = iframe.src;
            const timewall = document.getElementById("offerwall1");
            if (timewall) timewall.style.display = "none";
        })
      };

    // --- Gestion TimeWall ---
    if (btnGagner) {
        btnGagner.addEventListener("click", () => {
            if (typeof TimeWall === "undefined") return console.warn("TimeWall non chargÃ©");

            const container = document.getElementById("timewall-container");
            if (container) container.style.display = "block";

            TimeWall.show({
                userId: userID,
                onReward: async (data) => {
                    console.log("RÃ©compense reÃ§ue :", data);

                    // Mise Ã  jour Firebase
                    db.ref("users/" + userID + "/lastReward").set({
                        amount: data.currencyAmount,
                        date: Date.now()
                    });
                    updateBalance(Number(data.currencyAmount));

                    // Postback vers Render
                    try {
                        const params = new URLSearchParams({
                            userID: userID,
                            transactionID: data.transactionID,
                            revenue: data.revenue,
                            currencyAmount: data.currencyAmount,
                            type: data.type || "credit",
                            hash: data.hash
                        });
                        const res = await fetch(`${API_BASE}/timewall?${params.toString()}`);
                        if (!res.ok) throw new Error("Erreur postback Render");
                        console.log("âœ… Postback envoyÃ© Ã  Render");
                    } catch (err) {
                        console.error("âŒ Erreur postback TimeWall :", err);
                    }
                }
            });
        });
    }

    // --- Reload BitLabs iframe ---
    if (reloadBtn) {
        reloadBtn.addEventListener("click", () => {
            const iframe = document.getElementById("offerwall1");
            if (iframe) 
            iframe.src = iframe.src;
            iframe.style.display = "Block"
            const timewall = document.getElementById("timewall-container");
            if (timewall) timewall.style.display = "none";
        });
    }

    // --- Sync solde Firebase en direct ---
    db.ref("users/" + userID + "/balance").on("value", snapshot => {
        const value = snapshot.val();
        balanceEl.textContent = parseFloat(value || 0).toFixed(2) + " R$";
    });

    // --- RÃ©cupÃ©ration avatar Roblox via Render ---
    async function setRobloxAvatar(robloxName) {
        try {
            const res = await fetch(`${API_BASE}/api/avatar/${robloxName}`);
            if (!res.ok) throw new Error("Avatar non trouvÃ©");
            const data = await res.json();
            const avatarImg = document.getElementById("avatar-roblox");
            if (!avatarImg) return;
            avatarImg.src = data.avatarUrl || "../img/default-avatar.png";
            avatarImg.style.display = "inline-block";
        } catch (err) {
            console.error("Erreur avatar Roblox :", err);
        }
    }

});
</script>
</body>
</html>
