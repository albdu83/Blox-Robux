<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blox R$ - Profil</title>
    <link rel="stylesheet" href="Profil.css">
    <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
</head>

<body>
    <header>
        <a href="../index.html"><img src="../img/logo.png" alt="Logo De Blox Robux"></a>
        <div class="text">Blox R$</div>
        <ul>
            <li>
                <a id="Retour" href="../index.html">Retour</a>
            </li>
            <li>
            <a id="lien-profil" href="Profil.html" style="display:flex; align-items:center; gap:10px;">
                <span>Aucun compte</span>
                <img id="avatar-roblox" src="../img/default-avatar.png" style="width:40px; height:40px; border-radius:50%;">
            </a>
        </li>
        </ul>
    </header>

    <div class="welcome">
        <div class="pr√©sentation" id="acceuil">
            <div id="transition" class="fade-transition active">
                <img src="../img/Robux.png" id="image" alt="Logo Blox Robux" />
                <div class="text" id="text-chargement">Chargement...</div>
            </div>
        </div>
    </div>
    <div id="warn">
        <div>
            <span id="z">Veuillez vous reconnectez pour finaliser la proc√©dure !</span>
            <h3>Ancien nom d'utilisateur</h3>
            <input type="text" id="a" placeholder="Ancien nom d'utilisateur" required>
            <h3>Ancien mot de passe</h3>
            <input type="password" id="b" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            <input type="submit" value="Confirmer" id="Confirm">
            <p id="profileMessage2" class="msg"></p>
        </div>
    </div>
    <!-- ---------- PROFIL ---------- -->
    <main>

        <!-- SECTION 1 : MODIFIER PROFIL -->
        <section class="card">
            <h2>üë§ Informations du profil</h2>
            <h5 style="text-align: center;">(Si vous ne souhaitez pas modifier certaines informations, veuillez r√©√©crire les informations actuels pour la modification du profil!)</h5>
            <div class="form-group">
                <label>Nouveau pseudo Roblox</label>
                <input type="text" id="Roblox" placeholder="Votre nouveau pseudo Roblox">
            </div>

            <div class="form-group">
                <label>Nouveau mot de passe</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <div class="form-group">
                <label>Confirmez le mot de passe</label>
                <input type="password" id="email" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <div class="form-group">
                <label>Nouveau nom d'utilisateur</label>
                <input type="text" id="username" placeholder="Votre nouveau nom d'utilisateur" autocomplete="ex:1234">
            </div>

            <button id="saveProfile">Enregistrer les informations</button>

            <p id="profileMessage" class="msg"></p>
        </section>

        <!-- SECTION 2 : PROMOCODE -->
        <section class="card">
            <h2>üéÅ Entrer un promocode</h2>

            <div class="form-group">
                <label>Code</label>
                <input type="text" id="promoInput" placeholder="Entrez votre code">
            </div>

            <button id="applyPromo">Valider le code</button>

            <p id="promoMessage" class="msg"></p>
        </section>

        <!-- SECTION 3 : ADMIN -->
        <section class="card">
            <h2>üîê Acc√®s au panel admin</h2>

            <div class="form-group" id="form-group">
                <label>Code Administrateur</label>
                <input type="password" id="adminCode" placeholder="Mot de passe admin">
            </div>

            <button id="adminEnter">Se connecter</button>
            <p id="adminMessage" class="msg"></p>
        </section>

    </main>

    <!-- ---------- SCRIPTS ---------- -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../Data.js" defer></script>
    <script src="../Server.js" defer></script>
    <script src="../Animation.js" defer></script>

<script defer>
document.addEventListener("DOMContentLoaded", () => {
    const auth = firebase.auth();
    const db = window.db;
    const saveBtn = document.getElementById("saveProfile");
    const warn = document.getElementById("warn");
    const confirmBtn = document.getElementById("Confirm");
    const msg = document.getElementById("profileMessage");
    const msg2 = document.getElementById("profileMessage2");

    let pendingData = null;

    /* =========================
       ENREGISTRER PROFIL
    ========================== */
    saveBtn.addEventListener("click", async () => {
        msg.textContent = "";

        const user = auth.currentUser;
        if (!user) return showMsg(msg, "‚ùå Utilisateur non connect√©");

        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const confirmPassword = document.getElementById("email").value.trim();
        const robloxName = document.getElementById("Roblox").value.trim();

        if (!username || !password || !confirmPassword || !robloxName) 
            return showMsg(msg, "‚ùå Informations manquantes");
        if (password !== confirmPassword) 
            return showMsg(msg, "‚ùå Les mots de passe ne correspondent pas");
        if (password.length < 6) 
            return showMsg(msg, "‚ùå Mot de passe trop court");

        /* V√©rif pseudo Roblox via backend */
        try {
            const res = await fetch(`${API_BASE_URL}/api/roblox-user/${robloxName}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ usernames: [robloxName], excludeBannedUsers: true })
            });
            const data = await res.json();
            if (!data?.data?.length) return showMsg(msg, "‚ùå Pseudo Roblox inexistant");
        } catch {
            return showMsg(msg, "‚ùå Erreur serveur Roblox");
        }

        /* On stocke l‚Äôaction */
        pendingData = { username, password, robloxName };
        warn.style.display = "flex";
    });

    /* =========================
       CONFIRMATION (R√âAUTH)
    ========================== */
    confirmBtn.addEventListener("click", async () => {
        msg2.textContent = "";
        if (!pendingData) return;

        const user = auth.currentUser;
        const oldUsername = document.getElementById("a").value.trim();
        const oldPassword = document.getElementById("b").value.trim();
        if (!oldUsername || !oldPassword) return showMsg(msg2, "‚ùå Informations manquantes");

        /* --- R√©cup√©ration de l'email via backend --- */
        let email;
        try {
            const emailRes = await fetch(`${API_BASE_URL}/getEmail?username=${encodeURIComponent(oldUsername)}`);
            if (!emailRes.ok) return showMsg(msg2, "‚ùå Ancien nom d'utilisateur incorrect");
            const json = await emailRes.json();
            email = json.email;
        } catch {
            return showMsg(msg2, "‚ùå Impossible de r√©cup√©rer l'email");
        }

        /* --- R√©authentification --- */
        try {
            const credential = firebase.auth.EmailAuthProvider.credential(email, oldPassword);
            await user.reauthenticateWithCredential(credential);
        } catch {
            return showMsg(msg2, "‚ùå Mot de passe incorrect");
        }

        /* --- Mise √† jour du profil via Firebase --- */
        try {
            const uid = user.uid;

            /* On met √† jour DB et Firebase Auth */
            const updates = {
                username: pendingData.username,
                RobloxName: pendingData.robloxName
            };
            await db.ref(`users/${uid}`).update(updates);
            await user.updatePassword(pendingData.password);

            warn.style.display = "none";
            showMsg(msg, "‚úÖ Profil mis √† jour", true);

            // reset champs
            ["username","password","email","Roblox","a","b"].forEach(id => document.getElementById(id).value = "");
            pendingData = null;

        } catch (err) {
            console.error(err);
            showMsg(msg2, "‚ùå Erreur lors de la mise √† jour");
        }
    });

    /* =========================
       Fonctions utilitaires
    ========================== */
    function showMsg(el, text, success=false) {
        el.textContent = text;
        el.style.color = success ? "#00ff6a" : "#ff5555";
        setTimeout(() => el.textContent = "", 3000);
    }


        /* ----- PROMOCODE ----- */
        document.getElementById("applyPromo").addEventListener("click", () => {
            const code = document.getElementById("promoInput").value.trim().toLowerCase();
            const promos = { "welcome100": 100, "bonus50": 50, "mega500": 500 };

            const msg = document.getElementById("promoMessage");

            if (promos[code]) {
                let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { balance: 0 };
                data.balance += promos[code];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                msg.style.color = "#00ff6a";
                msg.textContent = `‚úîÔ∏è +${promos[code]} R$ ajout√© !`;
            } else {
                msg.style.color = "#ff5555";
                msg.textContent = "‚ùå Code invalide.";
            }

            setTimeout(() => msg.textContent = "", 3000);
        });

        /* ----- ADMIN ----- */
        document.getElementById("adminEnter").addEventListener("click", () => {
            const codeInput = document.getElementById("adminCode").value;
            const msg = document.getElementById("adminMessage");
            db.ref("admin/code").once("value").then(snapshot => {
                const correctCode = snapshot.val();

                if (codeInput === correctCode) {
                    msg.style.color = "#00ff6a";
                    msg.textContent = "‚úÖ Code correct.";
                    setTimeout(() => {
                        window.location.href = "../admin/adminpanel.html";
                    }, 1000);
                } else {
                    msg.style.color = "#ff5555";
                    msg.textContent = "‚ùå Code invalide.";
                }
                });
            });
        })
    </script>
</body>
</html>
