<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blox R$ - Profil</title>
    <link rel="stylesheet" href="Profil.css">
    <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
</head>
<body>
    <div id="disconnect">
    <h1>Vous avez √©t√© d√©connect√©... üò≠</h1>
    <h2>Pour acc√©der aux fonctions du site web, merci de bien vouloir vous (re)connecter.</h2>
    <a href="../page de connexion/index.html">Se connecter ?</a>
  </div>
      <div class="welcome">
        <div class="pr√©sentation" id="acceuil">
            <div id="transition" class="fade-transition active">
                <img src="../img/Robux.png" id="image" alt="Logo Blox Robux" />
                <div class="text" id="text-chargement">Chargement...</div>
            </div>
        </div>
    </div>
    <div id="body">
        <header>
        <a href="../index.html"><img src="../img/logo.png" alt="Logo De Blox Robux"></a>
        <div class="text">Blox R$</div>
        <div class="logo2">
            <img src="../img/Barres.png" alt="Barres" id="barres">
        </div>
    </header>
    <div class="header-shadow"></div>
    <div class="navigation" id="navigation">
  <div class="nav-panel" id="nav-panel">
    <div class="logo2" id="logo2">
        <img src="../img/Back.png" alt="Barres" id="barres2">
    </div>
    <ul class="nave">
        <li>
        <a id="lien-profil" href="#">
          <span>Aucun compte</span>
          <img id="avatar-roblox" src="../img/default-avatar.png">
        </a>
      </li>
      <li><a id="btn-Retour" href="../index.html">Retour</a></li>
    </ul>
  </div>
</div>
    <div id="warn">
        <div>
            <span id="z">Veuillez vous reconnectez pour finaliser la proc√©dure</span>
            <h3>Nom d'utilisateur actuel</h3>
            <input type="text" id="a" placeholder="Nom d'utilisateur actuel" required>
            <h3>Mot de passe actuel</h3>
            <input type="password" id="b" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            <input type="submit" value="Confirmer" id="Confirm">
            <img src="../img/loading.gif" alt="loading" id="loading">
            <p id="profileMessage2" class="msg"></p>
        </div>
    </div>
<div id="background">
<div class="container">
  <div id="container">
    <h2 style="color: yellow; text-align: center;">üë§ Informations du compte</h2>
    <img src="../img/default-avatar.png" alt="avatar" id="roblox">
    <h4 id="pseudoR">...</h4>
    <div id="infos">
  <div class="info-box">
  <span class="label">Robux gagn√©s</span>
  <span class="value" id="robuxGagnes">...</span>
</div>
<div class="info-box">
  <span class="label">Balance</span>
  <span class="value" id="balance">...</span>
</div>
<div class="info-box">
  <span class="label">Retraits</span>
  <span class="value" id="retraits">...</span>
</div>
<div class="info-box">
  <span class="label">Statut</span>
  <span class="value" id="statut">...</span>
</div>
<div class="info-box">
  <span class="label">Nom Roblox</span>
  <span class="value" id="nomRoblox">...</span>
</div>
<div class="info-box">
  <span class="label">Nom d'utilisateur</span>
  <span class="value" id="Username">...</span>
</div>
<div class="info-box">
  <span class="label">date de c√©ation</span>
  <span class="value" id="motdepasse">...</span>
</div>
<div class="info-box">
  <span class="label">Nombre de connexions</span>
  <span class="value" id="nbConnexions">...</span>
</div>
  </div>
</div>
  </div>
</div>
    <!-- ---------- PROFIL ---------- -->
    <main>

        <!-- SECTION 1 : MODIFIER PROFIL -->
        <section class="card">
            <h2>üë§ Modification du profil</h2>
            <h5 style="text-align: center;">(Si vous ne souhaitez pas modifier certaines informations, veuillez r√©√©crire les informations actuels pour la modification du profil!)</h5>
            <div class="form-group">
                <label>Nouveau pseudo Roblox</label>
                <input type="text" id="Roblox" placeholder="Votre nouveau pseudo Roblox">
            </div>

            <div class="form-group">
                <label>Nouveau mot de passe</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <div class="form-group">
                <label>Confirmez le mot de passe</label>
                <input type="password" id="email" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <div class="form-group">
                <label>Nouveau nom d'utilisateur</label>
                <input type="text" id="username" placeholder="Votre nouveau nom d'utilisateur" autocomplete="ex:1234">
            </div>

            <button id="saveProfile">Enregistrer les informations</button>

            <p id="profileMessage" class="msg"></p>
        </section>

        <!-- SECTION 2 : PROMOCODE -->
        <section class="card">
            <h2>üéÅ Entrer un promocode</h2>

            <div class="form-group">
                <label>Code</label>
                <input type="text" id="promoInput" placeholder="Entrez votre code">
            </div>

            <button id="applyPromo">Valider le code</button>

            <p id="promoMessage" class="msg"></p>
        </section>

        <!-- SECTION 3 : ADMIN -->
        <section class="card">
            <h2>üîê Acc√®s au panel admin</h2>

            <div class="form-group" id="form-group">
                <label>Code Administrateur</label>
                <input type="password" id="adminCode" placeholder="Mot de passe admin">
            </div>

            <button id="adminEnter">Se connecter</button>
            <p id="adminMessage" class="msg"></p>
        </section>

    </main>

    <!-- ---------- SCRIPTS ---------- -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../Data.js" defer></script>
    <script src="../Server.js" defer></script>
    <script src="../Animation.js" defer></script>

<script defer>
document.addEventListener("DOMContentLoaded", () => {
    const auth = firebase.auth();
    const gif = document.getElementById("loading")
    const db = window.db;
    const saveBtn = document.getElementById("saveProfile");
    const warn = document.getElementById("warn");
    const confirmBtn = document.getElementById("Confirm");
    const msg = document.getElementById("profileMessage");
    const msg2 = document.getElementById("profileMessage2");
    const pseudoR = document.getElementById("pseudoR");

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = seconds % 60;
        return `${min} min ${sec.toString().padStart(2, "0")} s`;
    }

    let pendingData = null;

    firebase.auth().onAuthStateChanged(user => {
        if (!user) {
            console.log("Utilisateur non connect√©");
            return;
        }

        const uid = user.uid;
        updateProfileInfo(uid);
    });
    const imgage = document.getElementById("roblox");
    async function setRobloxAvatar(robloxName) {
        pseudoR.innerHTML = `@${robloxName}`;
        try {
            const res = await fetch(`https://blox-robux.onrender.com/api/avatar/${robloxName}`);
            const data = await res.json();
            if (!imgage) return;

            imgage.src = data.avatarUrl || "img/default-avatar.png";
            imgage.style.display = "inline-block";

        } catch (err) {
            console.error("Erreur avatar :", err);
        }
    }

    async function updateProfileInfo(uid) {
        try {
            const snapshot = await db.ref(`users/${uid}`).get();
            if (!snapshot.exists()) return;
            const data = snapshot.val();
            setRobloxAvatar(data.RobloxName)
            document.getElementById("robuxGagnes").textContent = data.robuxGagnes ?? "0";
            document.getElementById("retraits").textContent = Object.keys(data.transactions || {}).length;
            document.getElementById("balance").textContent = data.balance ?? "0";
            document.getElementById("statut").textContent = data.role ?? "Utilisateur";
            document.getElementById("nomRoblox").textContent = data.RobloxName ?? "‚Äî";
            document.getElementById("Username").textContent = data.username ?? "‚Äî";
            const date = data.createdAt ? new Date(data.createdAt).toLocaleDateString() : "‚Äî";
            document.getElementById("motdepasse").textContent = date;
            document.getElementById("nbConnexions").textContent = data.nbConnexions ?? "0";

        } catch (err) {
            console.error("Erreur mise √† jour profil :", err);
        }
    }

    /* =========================
       ENREGISTRER PROFIL
    ========================== */
    saveBtn.addEventListener("click", async () => {
        msg.textContent = "";

        const user = auth.currentUser;
        if (!user) return showMsg(msg, "‚ùå Utilisateur non connect√©");

        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const confirmPassword = document.getElementById("email").value.trim();
        const robloxName = document.getElementById("Roblox").value.trim();

        if (!username || !password || !confirmPassword || !robloxName) 
            return showMsg(msg, "‚ùå Informations manquantes");
        if (password !== confirmPassword) 
            return showMsg(msg, "‚ùå Les mots de passe ne correspondent pas");
        if (password.length < 6) 
            return showMsg(msg, "‚ùå Mot de passe trop court");

        /* V√©rif pseudo Roblox via backend */
        try {
            const res = await fetch(`${API_BASE_URL}/api/roblox-user/${robloxName}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ usernames: [robloxName], excludeBannedUsers: true })
            });
            const data = await res.json();
            if (!data?.data?.length) return showMsg(msg, "‚ùå Pseudo Roblox inexistant");
        } catch {
            return showMsg(msg, "‚ùå Erreur serveur Roblox");
        }

        /* On stocke l‚Äôaction */
        pendingData = { username, password, robloxName };

        warn.style.display = "flex";
        requestAnimationFrame(() => {
            warn.classList.add("active");
        });
    });

    /* =========================
       CONFIRMATION (R√âAUTH)
    ========================== */
    confirmBtn.addEventListener("click", async () => {
        confirmBtn.style.display = "none";
        gif.style.display = "flex";
        const DURATION = 5 * 60; // 300s
        let time = 0;

        const endTime = localStorage.getItem("endTime");

        if (endTime) {
        time = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
        }

        // ‚õî Si le timer est encore actif
        if (time > 0) {
            gif.style.display = "none"
            confirmBtn.style.display = "block"
            return showMsg(
                msg2,
                `‚ùå R√©essayez dans ${formatTime(time)}`
            );
        }

        msg2.textContent = "";
        if (!pendingData) {
            gif.style.display = "none";
            confirmBtn.style.display = "block";
            return;
        }

        const user = auth.currentUser;
        const oldUsername = document.getElementById("a").value.trim();
        const oldPassword = document.getElementById("b").value.trim();
        if (!oldUsername || !oldPassword) {
            gif.style.display = "none";
            confirmBtn.style.display = "block";
            return showMsg(msg2, "‚ùå Informations manquantes");
        }

        /* --- R√©cup√©ration de l'email via backend --- */
        let email;
        try {
            const emailRes = await fetch(`${API_BASE_URL}/getEmail?username=${encodeURIComponent(oldUsername)}`);
            if (!emailRes.ok) {
                gif.style.display = "none";
                confirmBtn.style.display = "block";
                return showMsg(msg2, "‚ùå nom d'utilisateur incorrect");
            }
            const json = await emailRes.json();
            email = json.email;
        } catch {
            gif.style.display = "none"
            confirmBtn.style.display = "block"
            return showMsg(msg2, "‚ùå Impossible de r√©cup√©rer les donn√©es");
        }

        /* --- R√©authentification --- */
        try {
            const credential = firebase.auth.EmailAuthProvider.credential(email, oldPassword);
            await user.reauthenticateWithCredential(credential);
        } catch {
            gif.style.display = "none"
            confirmBtn.style.display = "block"
            return showMsg(msg2, "‚ùå Mot de passe incorrect");
        }

        /* --- Mise √† jour du profil via Firebase --- */
        try {
            const uid = user.uid;

            /* On met √† jour DB et Firebase Auth */
            const updates = {
                username: pendingData.username,
                RobloxName: pendingData.robloxName
            };
            await db.ref(`users/${uid}`).update(updates);
            await user.updatePassword(pendingData.password);


            warn.classList.remove("active");

            warn.addEventListener("transitionend", function handleEnd() {
                warn.style.display = "none";
                warn.removeEventListener("transitionend", handleEnd);
            });
            gif.style.display = "none"
            confirmBtn.style.display = "block"
            showMsg(msg, "‚úÖ Profil mis √† jour", true);

            const newEndTime = Date.now() + DURATION * 1000;
            localStorage.setItem("endTime", newEndTime);
            time = DURATION;

            // reset champs
            ["username","password","email","Roblox","a","b"].forEach(id => document.getElementById(id).value = "");
            pendingData = null;

            const timer = setInterval(() => {
                time--;

                if (time <= 0) {
                    clearInterval(timer);
                    console.log("Temps √©coul√©");
                }
            }, 1000);

            } catch (err) {
                gif.style.display = "none"
                confirmBtn.style.display = "block"
                console.error(err);
                showMsg(msg2, "‚ùå Erreur lors de la mise √† jour");
            }
        });

    /* =========================
       Fonctions utilitaires
    ========================== */
    function showMsg(el, text, success=false) {
        el.textContent = text;
        el.style.color = success ? "#00ff6a" : "#ff5555";
        setTimeout(() => el.textContent = "", 3000);
    }
        /* ----- PROMOCODE ----- */
        document.getElementById("applyPromo").addEventListener("click", async () => {
            const inputEl = document.getElementById("promoInput");
            const codeInput = inputEl.value.trim().toUpperCase();
            const msg = document.getElementById("promoMessage");
            const user = firebase.auth().currentUser;
            if (!codeInput || /[.#$\[\]]/.test(codeInput)) {
                inputEl.value = ""
                return showMsg(msg, "‚ùå Code promo invalide.");
            }
            if (!user) return showMsg(msg, "‚ùå Vous devez √™tre connect√©");

            try {
                const snapshot = await db.ref(`promocodes/${codeInput}`).get();
                if (!snapshot.exists() || codeInput === "") {
                    inputEl.value = "";
                    return showMsg(msg, "‚ùå Code invalide."); 
                }

                const promo = snapshot.val();
                const now = new Date();

                // V√©rifier expiration
                if (promo.expiration && new Date(promo.expiration) < now) {
                    inputEl.value = ""
                    return showMsg(msg, "‚ùå Ce code a expir√©.");
                }

                // V√©rifier si utilisateur a d√©j√† utilis√©
                if (promo.usedBy && promo.usedBy[user.uid]) {
                    inputEl.value = ""
                    return showMsg(msg, "‚ùå Vous avez d√©j√† utilis√© ce code.");
                }

                // V√©rifier si le code a encore des utilisations
                if (promo.usesLeft !== undefined && promo.usesLeft <= 0) {
                    inputEl.value = ""
                    return showMsg(msg, "‚ùå Ce code n'est plus disponible.");
                }

                // Ajouter le Robux √† l'utilisateur
                const userRef = db.ref(`users/${user.uid}`);
                const userSnap = await userRef.get();
                const balance = userSnap.val()?.balance || 0;
                await userRef.update({ balance: balance + promo.amount });

                // Mettre √† jour le code promo (usedBy + decrement usesLeft)
                const updates = {};
                updates[`promocodes/${codeInput}/usedBy/${user.uid}`] = true;
                if (promo.usesLeft !== undefined) updates[`promocodes/${codeInput}/usesLeft`] = promo.usesLeft - 1;

                await db.ref().update(updates);
                inputEl.value = ""
                showMsg(msg, `‚úîÔ∏è +${promo.amount} R$ ajout√© !`, true);
            } catch (err) {
                console.error(err);
                inputEl.value = ""
                showMsg(msg, "‚ùå Une erreur est survenue.");
            }
        });

        /* ----- ADMIN ----- */
        document.getElementById("adminEnter").addEventListener("click", () => {
            const codeInput = document.getElementById("adminCode").value;
            const msg = document.getElementById("adminMessage");
            db.ref("admin/code").once("value").then(snapshot => {
                const correctCode = snapshot.val();

                if (codeInput === correctCode) {
                    msg.style.color = "#00ff6a";
                    msg.textContent = "‚úÖ Code correct.";
                    setTimeout(() => {
                        window.location.href = "../admin/adminpanel.html";
                    }, 1000);
                } else {
                    msg.style.color = "#ff5555";
                    msg.textContent = "‚ùå Code invalide.";
                    setTimeout(() => {
                        msg.textContent = ""
                    }, 3000);
                }
                });
            }); 
        })
    </script>
    </div>
</body>
</html>
